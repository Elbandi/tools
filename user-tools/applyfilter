#!/bin/bash

true <<'EOF'
=pod

=head1 NAME

applyfilter - Filter a file via a command's STDIO and write back to it

=head1 SYNOPSIS

applyfilter I<FILE> I<COMMAND> [I<ARGS>]

=head1 DESCRIPTION

Feed I<FILE> into I<COMMAND>'s stdin, then save its stdout back to I<FILE>
if I<COMMAND> ran successfully.

=head1 LIMITATIONS

=head1 SEE ALSO

sponge(1)

=cut

EOF


set -e
set -o pipefail
set -u

. /usr/lib/tool/bash-utils


opt_verbose=no


while [ $# != 0 ]
do
	case "$1" in
	--help)
		pod2text "$0"
		exit 0;;
	-v|--verbose)
		opt_verbose=yes
		;;
	--)
		shift
		break;;
	-*)
		errx -1 "unknown option: $1";;
	*)
		break;;
	esac
	shift
done


file=$1
shift

stdout=`cat "$file" | command "$@"`
# let us die if either cat or command failed
cat > "$file" <<< "$stdout"
