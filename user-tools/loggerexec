#!/bin/bash

true <<EOF
=pod

=head1 NAME

loggerexec - Run a command and send STDOUT and STDERR to syslog

=cut

EOF


if [ ".$1" = ".--help" ]
then
	echo "Usage: $0 [-s] <FACILITY> <IDENT> <COMMAND> [<ARGS>]"
	echo "Send COMMAND's stdout and stderr to syslog."
	echo "FACILITY is one of standard syslog facility names (user, mail, daemon, auth, local0, ...)"
	echo "IDENT is a freely choosen identity name, also known as tag or programname."
	echo "COMMAND's stdout goes as 'info' log level, stderr goes as 'error' log level."
	echo "Option '-s' puts the output on stdout/stderr too."
	exit
fi

declare -a logger_opts=()

if [ "$1" = -s ]
then
	logger_opts+=(-s)
	shift
fi

set -e
set -o pipefail
set -u

facility=$1
shift
ident=$1
shift

exec "$@" > >(logger -p "$facility.info" -t "$ident" "${logger_opts[@]}" 2>&1) 2> >(logger -p "$facility.error" -t "$ident" "${logger_opts[@]}")
