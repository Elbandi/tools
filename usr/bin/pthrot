#!/bin/bash

declare -a controller_cmd
declare -a controlled_cmd

while [ $# -gt 0 ]
do
	if [ "$1" = -- ]
	then
		shift
		break
	fi
	controller_cmd+=("$1")
	shift
done

while [ $# -gt 0 ]
do
	controlled_cmd+=("$1")
	shift
done

quit()
{
	kill -TERM -$pid
	if [ "$STATUS" = STOP ]
	then
		kill -CONT -$pid
	fi
	exit 130
}

trap quit TERM INT

setsid "${controlled_cmd[@]}" &
pid=$!
STATUS=RUN
export STATUS

while kill -0 -$pid 2>/dev/null
do
	stdout=`command "${controller_cmd[@]}"`
	code=$?
	mapfile -t output <<<"$stdout"
	delay=${output[-1]}
	
	if [ $code = 0 -a $STATUS != RUN ]
	then
		echo "pthrot: CONT $pid" >&2
		kill -CONT -$pid
		STATUS=RUN
	elif [ $code != 0 -a $STATUS = RUN ]
	then
		echo "pthrot: STOP $pid" >&2
		kill -STOP -$pid
		STATUS=STOP
	fi
	
	sleep ${delay:-0}
done

wait
